name: CI Integration

on:
  push:
    tags:
      - 'v*' # Trigger on version tags
  workflow_dispatch:

jobs:
  integration-test:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-west-1

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Connect to EKS (Dev)
        run: |
          aws eks update-kubeconfig --region eu-west-1 --name dev-helloworld

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Deploy App (Dev Version)
        run: |
          # Extract version from clusters/dev/release.yaml
          TAG=$(grep 'tag:' clusters/dev/release.yaml | awk '{print $2}')
          
          echo "Deploying version $TAG to Dev Environment"
          
          # Upgrade existing release or install if missing
          helm upgrade --install helloworld ./appManifests/helloworld \
            --namespace helloworld \
            --set image.tag=$TAG \
            --wait

      - name: Run E2E Tests
        run: |
          # Debug: List resources to see what's actually running
          echo "Debugging: Listing all resources in helloworld namespace"
          kubectl get all -n helloworld

          # Wait for pod to be ready (targeting the instance label to catch both primary and canary)
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=helloworld -n helloworld --timeout=120s
          
          # Simple connectivity test (using port-forward since Ingress might be internal or take time)
          kubectl port-forward svc/helloworld 8080:80 -n helloworld &
          PID=$!
          sleep 5
          
          echo "Testing endpoint..."
          curl -f http://localhost:8080 || (kill $PID && exit 1)
          
          kill $PID

      - name: Install yq
        if: success()
        run: |
          if ! command -v yq &> /dev/null; then
             wget https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 -O /usr/local/bin/yq && chmod +x /usr/local/bin/yq
          fi

      - name: Promote to Prod
        if: success()
        run: |
          # Capture the version from the current (tested) Dev configuration
          TAG=$(grep 'tag:' clusters/dev/release.yaml | awk '{print $2}')
          echo "Preparing to promote version $TAG to Production..."

          # Configure Git Identity
          git config user.name "damekarv"
          git config user.email "damekarviney@gmail.com"

          # Switch to main branch to commit the change
          git fetch origin main
          git checkout main
          git pull origin main

          # Update Prod Manifest
          yq -i "select(.metadata.name == \"helloworld\").spec.values.image.tag = \"$TAG\"" clusters/prod/release.yaml

          # Commit and Push
          git add clusters/prod/release.yaml
          
          if git diff --staged --quiet; then
            echo "Prod is already up to date with version $TAG"
          else
            git commit -m "chore(release): promote version $TAG to prod"
            git push origin main
          fi
